<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stella Maris Christmas Chapel Choir 2024</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap" rel="stylesheet"> <!-- Include Roboto Mono -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        #editor {
            width: 300%;
            height: 380vh;
            border: 1px solid #ccc;
            overflow-x: auto; /* Enable horizontal scrolling */
            overflow-y: auto; /* Enable vertical scrolling */
            white-space: pre; /* Preserve whitespace including spaces and tabs */
            padding: 10px;
            box-sizing: border-box;
            background-color: white;
            font-family: 'Roboto Mono', monospace; /* Set font to Roboto Mono */
        }
        #editor:focus {
            outline: none; /* Remove default outline */
        }
        .line {
            padding: 5px; /* Add some padding for better appearance */
        }
        button {
		background: none;
      		border: none;
      		cursor: pointer;
      		padding: 8px;
    	}
	.big-letter-container {
	    display: flex;
	    align-items: flex-start;
	    border-bottom: 2px solid black;   /* ‚Üê NEW */
	    margin-bottom: 1px;              /* Optional spacing */
	    padding-bottom: 3px;              /* Optional spacing */
	}

	.big-letter {
	    font-size: 120px;
	    font-weight: bold;
	    line-height: 1;
	    margin-right: 20px;
	}

    	svg {
      		width: 24px;
	        height: 24px;
      		vertical-align: middle;
    	}
#refresh-row {
    display: flex;
    align-items: flex-start;
    gap: 20px;            /* Space between icon and table */
}

#dynamic-table {
    border-collapse: collapse;
    font-size: 14px;
    background: white;
}

#dynamic-table td {
    padding: 2px 6px;
}

    </style>
</head>
<body>

<h3 id="hymn">Stella Maris Christmas 2024</h3>
</hr>
<div id="refresh-row">
<button onclick="refreshLyrics()">

    <!-- SVG refresh icon -->
<svg width="64px" height="64px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" transform="rotate(0)matrix(1, 0, 0, 1, 0, 0)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="3.9839999999999995"> <path d="M16.3788 6.20698C15.1885 5.25459 13.7434 4.5 12 4.5C7.85787 4.5 4.5 7.85786 4.5 12C4.5 16.1421 7.85787 19.5 12 19.5C15.2549 19.5 18.028 17.4254 19.0646 14.5256C19.2505 14.0055 19.775 13.6568 20.3153 13.7713L21.2935 13.9787C21.8338 14.0932 22.1836 14.6262 22.0179 15.1531C20.6787 19.4112 16.7016 22.5 12 22.5C6.20101 22.5 1.5 17.799 1.5 12C1.5 6.20101 6.20101 1.5 12 1.5C14.7835 1.5 16.9516 2.76847 18.5112 4.0746L20.2929 2.29289C20.5789 2.00689 21.009 1.92134 21.3827 2.07612C21.7564 2.2309 22 2.59554 22 3V8.5C22 9.05228 21.5523 9.5 21 9.5H15.5C15.0956 9.5 14.7309 9.25636 14.5761 8.88268C14.4214 8.50901 14.5069 8.07889 14.7929 7.79289L16.3788 6.20698Z" fill="#371a94"></path> </g><g id="SVGRepo_iconCarrier"> <path d="M16.3788 6.20698C15.1885 5.25459 13.7434 4.5 12 4.5C7.85787 4.5 4.5 7.85786 4.5 12C4.5 16.1421 7.85787 19.5 12 19.5C15.2549 19.5 18.028 17.4254 19.0646 14.5256C19.2505 14.0055 19.775 13.6568 20.3153 13.7713L21.2935 13.9787C21.8338 14.0932 22.1836 14.6262 22.0179 15.1531C20.6787 19.4112 16.7016 22.5 12 22.5C6.20101 22.5 1.5 17.799 1.5 12C1.5 6.20101 6.20101 1.5 12 1.5C14.7835 1.5 16.9516 2.76847 18.5112 4.0746L20.2929 2.29289C20.5789 2.00689 21.009 1.92134 21.3827 2.07612C21.7564 2.2309 22 2.59554 22 3V8.5C22 9.05228 21.5523 9.5 21 9.5H15.5C15.0956 9.5 14.7309 9.25636 14.5761 8.88268C14.4214 8.50901 14.5069 8.07889 14.7929 7.79289L16.3788 6.20698Z" fill="#371a94"></path> </g></svg>
  </button>
<table id="dynamic-table">
        <tr><td>S - Soft</td></tr>
        <tr><td>M - Medium</td></tr>
        <tr><td>L - Loud</td></tr>
        <tr><td>A - Soft to Loud (Ascending)</td></tr>
        <tr><td>D - Loud to Soft (Descending)</td></tr>
    </table>
</div>
<div id="editor" contenteditable="false"></div> <!-- Default text set inline -->

<script>
    const editor = document.getElementById('editor');
    const hymn = document.getElementById('hymn');

    // Use a regular expression to insert spaces before each uppercase letter
    function insertSpaces(camelCaseString) {         
        return camelCaseString.replace(/([a-z])([A-Z])/g, '$1 $2');
    }
    
    // Function to get the filename from query string
    function getFileNameFromQuery() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('file') || 'text'; // Default to 'text.txt' if no parameter is found
    }


function refreshLyrics() {
    const fileNameParam = getFileNameFromQuery();
    const fullPath = fileNameParam.concat('/', fileNameParam, '.txt');
    
    // Force bypass cache by appending a timestamp
    const url = fullPath + '?nocache=' + new Date().getTime();

    // Fetch the latest version directly from the server
    fetch(url, { cache: 'no-store' })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(data => {
            // Update both cache and display
            localStorage.setItem(fullPath, data);
            editor.innerHTML = '';
            applyLineStyles(data);
        })
        .catch(error => {
            console.error('Error refreshing file:', error);
            alert('Could not refresh the lyrics. Please check your connection.');
        });
}


    // Load text from the specified text file when the page loads
window.onload = function() {
    let fileName = getFileNameFromQuery(); // Get the filename from query string
    let reload = getQueryParameter("Reload"); // Check if "Reload" parameter is present

    hymn.innerText = insertSpaces(fileName); // Set Hymn title
    fileName = fileName.concat('/', fileName, '.txt');
    console.log(fileName);

    // Check if the content is already in cache and if we need to reload it
    if (!reload && localStorage.getItem(fileName)) {
        // Load from cache
        const cachedData = localStorage.getItem(fileName);
        editor.innerHTML = ''; // Clear current content
        applyLineStyles(cachedData); // Apply background colors after loading content from cache
    } else {
        // Fetch from server
        fetch(fileName) // Fetch the text file
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text(); // Read the response as text
            })
            .then(data => {
                localStorage.setItem(fileName, data); // Save fetched data to cache
                editor.innerHTML = ''; // Clear current content
                applyLineStyles(data); // Apply background colors after loading content
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                editor.innerText = "Hello, Something went wrong and I can't read the lyrics of the hymn. Please contact the software developer i.e. your musician :) "; // Fallback content if fetch fails
            });
    }

    editor.focus(); // Focus the editor
};

// Helper function to get query parameters from URL
function getQueryParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}


    // Function to apply alternating line styles
    function applyLineStyles(data) {
    const lines = data.split('\n');

    // Process in blocks of 5 to avoid duplicate rendering
    for (let i = 0; i < lines.length; i += 5) {
        const block = lines.slice(i, i + 5);

        // If we have a full block of 5 lines and the 5th is a single capital letter, render the big-letter layout
        if (block.length === 5 && /^[A-Z]$/.test(block[4].trim())) {
            const container = document.createElement('div');
            container.classList.add('big-letter-container');

            // Big letter on the left
            const big = document.createElement('div');
            big.classList.add('big-letter');
            big.textContent = block[4].trim();

            // Right column with the 4 colored lines
            const rightCol = document.createElement('div');

            for (let j = 0; j < 4; j++) {
                const smallDiv = document.createElement('div');
                smallDiv.classList.add('line');
                smallDiv.textContent = block[j];

                // Use original global index for color selection
                const idx = i + j;
                switch (idx % 5) {
                    case 0: smallDiv.style.backgroundColor = 'lightblue'; break;
                    case 1: smallDiv.style.backgroundColor = 'lightpink'; break;
                    case 2: smallDiv.style.backgroundColor = 'azure'; break;
                    case 3: smallDiv.style.backgroundColor = 'lightgreen'; break;
                }

                rightCol.appendChild(smallDiv);
            }

            container.appendChild(big);
            container.appendChild(rightCol);
            editor.appendChild(container);
        } else {
            // Render each line in the block individually (handles blocks that don't have a capital-letter 5th line
            // and also handles trailing blocks < 5 lines)
            for (let j = 0; j < block.length; j++) {
                const idx = i + j;
                const div = document.createElement('div');
                div.classList.add('line');
                div.textContent = block[j];

                // If this is the 5th position (index % 5 === 4) and not a capital letter,
                // keep the black full-width background as before
                if (idx % 5 === 4) {
                    div.style.backgroundColor = 'black';
                } else {
                    switch (idx % 5) {
                        case 0: div.style.backgroundColor = 'lightblue'; break;
                        case 1: div.style.backgroundColor = 'lightpink'; break;
                        case 2: div.style.backgroundColor = 'azure'; break;
                        case 3: div.style.backgroundColor = 'lightgreen'; break;
                    }
                }

                editor.appendChild(div);
            }
        }
    }
}


    
    // Optional: Handle key events for additional functionality
    editor.addEventListener('keydown', (event) => {
        if (event.key === 'Tab') {
            event.preventDefault(); // Prevent default tab behavior
            document.execCommand('insertText', false, '    '); // Insert four spaces
        }
    });
</script>

</body>
</html>
